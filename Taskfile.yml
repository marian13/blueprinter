version: '3'

##
# NOTE: `open` tasks only navigate/open apps. They are NOT running any other commands.
##

##
# IMPORTANT: All tasks listed in this file should be executed from the root folder.
# - https://taskfile.dev/usage/#task-directory
#
tasks:
  ##
  # NOTE: `docker compose run` automatically builds image if is not built yet.
  #
  docker:bash:
    cmds:
      - docker compose -f docker/development/docker-compose.yml run --rm rails bash
    interactive: true
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)

  ##
  # NOTE:
  #   `task install` is executed during image build process.
  #   But it is impossible to have access to the volumes during the image build process.
  #   So `Gemfile` changes are NOT persisted inside `Gemfile.lock`.
  #   That is why `task install` is executed for the second time by `docker compose run` since it has access to volumes.
  #   This add more minutes to `task docker:build`, but eliminates the time required to debug unmodified `Gemfile.lock` issues.
  #
  # NOTE:
  #   `docker compose up` builds all images listed in the `docker-compose.yml` and then starts all containers.
  #   This is too resource heavy most of the time, that is why `docker compose build` and `docker compose run` with Docker Compose `depends_on` are used instead.
  #
  docker:build:
    cmds:
      - docker compose -f docker/development/docker-compose.yml build rails
      - docker compose -f docker/development/docker-compose.yml run --rm rails bash -c "task install"
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)

  docker:chrome:build:
    cmds:
      - docker-compose -f docker/development/docker-compose.yml up --build --remove-orphans chrome
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)

  docker:chrome:http:open:
    cmds:
      - open http://localhost:{{.CHROME_HTTP_PORT}}
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)
    requires:
      vars: [CHROME_HTTP_PORT]

  docker:chrome:logs:
    cmds:
      - docker logs --follow {{.PROJECT_NAME}}_chrome
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)
    requires:
      vars: [PROJECT_NAME]

  docker:chrome:vnc:open:
    cmds:
      - open vnc://localhost:{{.CHROME_VNC_PORT}}
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)
    requires:
      vars: [CHROME_VNC_PORT]

  ##
  # NOTE: Importmap for Rails.
  # - https://github.com/rails/importmap-rails?tab=readme-ov-file#using-npm-packages-via-javascript-cdns
  #
  docker:importmap:pin:
    cmds:
      - docker compose -f docker/development/docker-compose.yml run --rm rails bash -c './bin/importmap pin {{.NPM_PACKAGE}}'
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)

  docker:rspec:
    cmds:
      - docker compose -f docker/development/docker-compose.yml run --rm rails bash -c 'bundle exec rspec'
    interactive: true
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)

  docker:server:
    cmds:
      - rm tmp/pids/server.pid 2> /dev/null || true
      ##
      # NOTE: `-b 0.0.0.0` makes Rails server accessible from all hosts.
      # - https://stackoverflow.com/a/29084070/12201472
      #
      - |
        docker compose \
          -f docker/development/docker-compose.yml \
          run \
          --rm \
          --publish {{.RAILS_PORT}}:{{.RAILS_PORT}} \
          rails \
          bash -c '
            bundle exec rails db:create \
              && bundle exec rails db:migrate \
              && bundle exec rails server --port {{.RAILS_PORT}} -b 0.0.0.0
          '
    interactive: true
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)
    requires:
      vars: [RAILS_PORT]

  docker:server:open:
    cmds:
      - open -na "Google Chrome" --args --new-window --incognito "http://localhost:{{.RAILS_PORT}}"
    requires:
      vars: [RAILS_PORT]

  docker:turnip:
    cmds:
      - |
        docker compose \
          -f docker/development/docker-compose.yml \
          run \
          --rm \
          --publish {{.TURNIP_RAILS_PORT}}:{{.TURNIP_RAILS_PORT}} \
          rails \
          bash -c '
            bundle exec rspec --require turnip/rspec spec/features
          '
    interactive: true
    preconditions:
      - sh: '[ "${IN_DOCKER_CONTAINER}" != "true" ]'
        msg: This task can be invoked only from the host operating system (https://www.ibm.com/cloud/learn/containerization)
    requires:
      vars: [TURNIP_RAILS_PORT]

  ##
  # NOTE: Dev only command.
  # NOTE: macOS specific command.
  # NOTE: Used by `tmuxinator`.
  #
  docker:start:
    cmds:
      - open -a Docker

  ##
  # NOTE: Dev only command.
  #
  editor:open:
    cmds:
      - code .

  ##
  # NOTE: Dev only command.
  # NOTE: macOS specific command.
  #
  github:open:
    cmds:
      - open -na "Google Chrome" --args --new-window --incognito "https://github.com/marian13/blueprinter"

  install:
    cmds:
      - bundle install

  server:logs:test:
    cmds:
      - touch log/test.log && tail -f log/test.log

  ##
  # NOTE: Dev only command.
  #
  tmuxinator:start:
    cmds:
      - direnv exec . tmuxinator start blueprinter --project-config=.dev/.tmuxinator.yml
